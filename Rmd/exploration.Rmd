---
title: "exploration"
author: "Andrea Julca"
date: "9/14/2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(rworldmap)
library(rgdal)
library(gpclib)
library(ggplot2)
library(rgeos)
library(maptools)
library(maps)
library(geosphere)
library(shiny)
library(leaflet)
```

## Get species data and country codes
And download shape files for maps if not already done

```{r fish}
#Copy sample dataset
#dPath <- '/nfs/jgephart-data/Species Network/'
#file.copy(paste0(dPath, 'species_trade_2010_2011.txt'), '/research-home/ajulca/data/species_trade.txt', overwrite = FALSE)
#file.copy(paste0(dPath, 'Country_Codes_Names.txt'), '/research-home/ajulca/data/Country_Codes_Names.txt', overwrite = TRUE)

#Get shapefile
#download.file('http://thematicmapping.org/downloads/TM_WORLD_BORDERS-0.3.zip', '/research-home/ajulca/data/World_Borders.zip')
#unzip('/research-home/ajulca/data/World_Borders.zip', exdir = '/research-home/ajulca/data/')

dPath <- '/research-home/ajulca/data/'

##data.table fread not the best here; just use base read.table
#cNames <- fread(paste0(dPath, 'Country_Codes_Names.txt'), col.names = c('rNo', 'ISO_Code', 'Area_Name', 'ISO_Alpha'))
#sTrade <- fread(paste0(dPath, 'species_trade.txt'), col.names = c('rNo', 'Import', 'Export', 'Species', 'value', 'Year'), skip = 1)
cNames <- data.table(read.table(paste0(dPath, 'Country_Codes_Names.txt')))
sTrade <- data.table(read.table(paste0(dPath, 'species_trade.txt')))
setkey(cNames, key = ISO_Code)
setkey(sTrade, key = Import)

wDT <- cNames[sTrade]
#I know Japan is a net importer of fish; let's check to make sure colnames mean what we think they mean
sum(unique(wDT[Area_Name == 'Japan', value]))
  
wDT[Year == 2010 & Area_Name == 'Japan' & Species == 'a']

```

#Finding an acceptable mapping tool
## rworldmap
Use rworldmap to start out with 

```{r rworldmap}
#Look at countries exporting to Japan - species 'a', wherever export = Japan's code (392)
wMap10 <- joinCountryData2Map(wDT[Year == 2010 & Export == 392 & Species == 'a', .(ISO_Alpha, value)], joinCode = 'ISO3', nameJoinColumn = 'ISO_Alpha')
#Don't like that - map failure for a number of values

mapCountryData(wMap10, nameColumnToPlot="value", mapTitle="World", catMethod="categorical", addLegend = FALSE)


```

## ggplot2 with shapefile
Still need to incorporate sample data with this. May be easier to integrate plotting points on this 
(as in http://kateto.net/network-visualization) than rworldmap, but need to use small shapefile for speed
```{r ggplot}
try({gpclibPermit()
world.map <- readOGR(dsn="data", layer="TM_WORLD_BORDERS-0.3")
world.ggmap <- fortify(world.map, region = "NAME")

n <- length(unique(world.ggmap$id))
df <- data.frame(id = unique(world.ggmap$id),
                 growth = 4*runif(n),
                 category = factor(sample(1:5, n, replace=T)))

## noise
df[c(sample(1:100,40)),c("growth", "category")] <- NA


ggplot(df, aes(map_id = id)) +
     geom_map(aes(fill = growth, color = category), map =world.ggmap) +
     expand_limits(x = world.ggmap$long, y = world.ggmap$lat) +
     scale_fill_gradient(low = "red", high = "blue", guide = "colorbar")
})
#ggplot(df, aes(map_id = id)) +
#  geom_map(aes(fill = growth, color = category), map =world.ggmap) +
#  expand_limits(x = world.ggmap$long, y = world.ggmap$lat) +
#  scale_fill_gradient(high = "red", low = "white", guide = "colorbar") +
#  scale_colour_hue(h = c(120, 240))
```


## maps + geosphere
This also does not appear to be responsive to window size... In fact, ruins window size for the rest of us.
We'll just suppress this section.
```{r maps_gs}
#par(mfrow = c(2,2), mar=c(0,0,0,0))
#par(mfrow = c(1,1), mar = c(1,1,1,1))
#map("usa", col="tomato",  border="gray10", fill=TRUE, bg="gray30")
#map("state", col="orange",  border="gray10", fill=TRUE, bg="gray30")
#map("county", col="palegreen",  border="gray10", fill=TRUE, bg="gray30")
#map("world", col="skyblue",  border="gray10", fill=TRUE, bg="gray30")


#map("world", fill=TRUE, col="white", bg="lightblue", ylim=c(-60, 90), mar=c(0,0,0,0))
#points(visit.x,visit.y, col="red", pch=16)
```

## leaflet
```{r leaflet}
#Based on https://rstudio.github.io/leaflet/colors.html and https://rstudio.github.io/leaflet/shiny.html and http://stackoverflow.com/questions/29118059/display-spatialpolygonsdataframe-on-leaflet-map-with-r
library(shiny)
library(leaflet)
library(RColorBrewer)
library(rgdal)

#Just use tempfile for now
download.file(file.path('http://www.naturalearthdata.com/http/',
                        'www.naturalearthdata.com/download/50m/cultural',
                        'ne_50m_admin_0_countries.zip'), 
              f <- tempfile())
unzip(f, exdir=tempdir())

world <- readOGR(tempdir(), 'ne_50m_admin_0_countries', encoding='UTF-8')

commonwealth <- cNames[, Area_Name]

leaflet() %>% addTiles() %>% 
  addPolygons(data=subset(world, name %in% commonwealth), weight=2)

# From http://data.okfn.org/data/datasets/geo-boundaries-world-110m
countries <- readOGR("json/countries.geojson", "OGRGeoJSON")
map <- leaflet(countries)

r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()


#Plotting curved trade paths in leaflet

library(geosphere)
gcIntermediate(c(5,52), c(-120,37),
               n=100, 
               addStartEnd=TRUE,
               sp=TRUE) %>% 
leaflet() %>% 
addTiles() %>% 
addPolylines()

```

## leaflet with shiny
Looks like the easiest first pass
```{r shinyleaf}
#Not actually using Jessica's data for this yet
library(RColorBrewer)

ui <- bootstrapPage(
  tags$style(type = "text/css", "html, body {width:100%;height:100%}"),
  leafletOutput("map", width = "100%", height = "100%"),
  absolutePanel(top = 10, right = 10,
    sliderInput("range", "Magnitudes", min(quakes$mag), max(quakes$mag),
      value = range(quakes$mag), step = 0.1
    ),
    selectInput("colors", "Color Scheme",
      rownames(subset(brewer.pal.info, category %in% c("seq", "div")))
    ),
    checkboxInput("legend", "Show legend", TRUE)
  )
)

server <- function(input, output, session) {

  # Reactive expression for the data subsetted to what the user selected
  filteredData <- reactive({
    quakes[quakes$mag >= input$range[1] & quakes$mag <= input$range[2],]
  })

  # This reactive expression represents the palette function,
  # which changes as the user makes selections in UI.
  colorpal <- reactive({
    colorNumeric(input$colors, quakes$mag)
  })

  output$map <- renderLeaflet({
    # Use leaflet() here, and only include aspects of the map that
    # won't need to change dynamically (at least, not unless the
    # entire map is being torn down and recreated).
    leaflet(quakes) %>% addTiles() %>%
      fitBounds(~min(long), ~min(lat), ~max(long), ~max(lat))
  })

  # Incremental changes to the map (in this case, replacing the
  # circles when a new color is chosen) should be performed in
  # an observer. Each independent set of things that can change
  # should be managed in its own observer.
  observe({
    pal <- colorpal()

    leafletProxy("map", data = filteredData()) %>%
      clearShapes() %>%
      addCircles(radius = ~10^mag/10, weight = 1, color = "#777777",
        fillColor = ~pal(mag), fillOpacity = 0.7, popup = ~paste(mag)
      )
  })

  # Use a separate observer to recreate the legend as needed.
  observe({
    proxy <- leafletProxy("map", data = quakes)

    # Remove any existing legend, and only if the legend is
    # enabled, create a new one.
    proxy %>% clearControls()
    if (input$legend) {
      pal <- colorpal()
      proxy %>% addLegend(position = "bottomright",
        pal = pal, values = ~mag
      )
    }
  })
}

shinyApp(ui, server)

```

## Prelim attempt at shiny with d3.js
```{r shinyd3}

library(shiny)

test <- rbind(c("name","parent","color","point"),
c("Paul Jacobs","","black","black"),
c("Jency","Paul Jacobs","gray","gray"),
c("Graham","Paul Jacobs","gray","gray"),
c("Raja","Paul Jacobs","gray","gray"),
c("Suyan","Paul Jacobs","gray","gray"),
c("Andrea Julca","Paul Jacobs","steelblue","goldenrod"),
c("Naveen","Paul Jacobs","gray","gray"),
c("Kunal","Paul Jacobs","gray","gray"),
c("Zhenye","Paul Jacobs","gray","gray"),
c("Matthew","Paul Jacobs","gray","gray"),
c("Michael","Paul Jacobs","gray","gray"),
c("Alexandra","Paul Jacobs","gray","gray"),
c("Nicholas","Paul Jacobs","gray","gray"),
c("Alex","Paul Jacobs","gray","gray"),
c("Susan","Paul Jacobs","gray","gray"),
c("Tu","Paul Jacobs","gray","gray"),
c("Edel","Paul Jacobs","gray","gray"),
c("Jean-Paul","Paul Jacobs","gray","gray"),
c("Sandra","Paul Jacobs","gray","gray"),
c("Dimitri","Paul Jacobs","gray","gray"),
c("Binghuan","Paul Jacobs","gray","gray"),
c("Xinyun","Paul Jacobs","gray","gray"))

#write.table(test, file = 'data/rosters.csv', row.names = FALSE, col.names = testNames, sep = ',')
testDT <- data.table(test)
writeLines(testDT[, paste(V1,V2,V3,V4, sep = ',')])
#testDT

myCSS <- 'body {
   font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: 200;
	}

	.node circle {
		fill: #999;
	}

	.node text {
		font: 12px sans-serif;
		color: #1A74AC;
		text-shadow: 0 .5px 0 #fff, 0 -1px 0 #fff, .5px 0 0 #fff, -1px 0 0 #fff;
	}

	.node--internal circle {
		fill: #555;
	}

	.node--internal text {
		text-shadow: 0 .5px 0 #fff, 0 -1px 0 #fff, .5px 0 0 #fff, -1px 0 0 #fff;
	}

	.link {
		fill: none;
		stroke: #555;
		stroke-opacity: 0.4;
		stroke-width: 1.5px;
	}
'
writeLines(myCSS, 'style.css')

myJS <- paste0('var svg = d3.select("svg"),
				width = +svg.attr("width"),
				height = +svg.attr("height"),
				g = svg.append("g").attr("transform", "translate(40,0)");

			
		var tree = d3.tree()
			.size([height, width - 200]);
		
		var stratify = d3.stratify()
			.id(function(d) {
				//console.log([d.name, d.parent]); 
				return d.name; })
			.parentId(function(d) {return d.parent})
//			(data);
	d3.csvParse("', paste(testDT[, paste0(V1,V2,V3,V4, sep = ',')], collapse = '\n'), '", function(error, data) {
		if (error) throw error;
		//console.log(data)
		//var table = d3.csvParse(data);
		var root = stratify(data)
				.sort(function(a, b) { return (a.height - b.height) || a.id.localeCompare(b.id); });
		tree(root);
		
		//console.log(root)

		var link = g.selectAll(".link")
				.data(root.descendants().slice(1))
			.enter().append("path")
				.style("stroke", function(d) { return d.point; })
				.style("fill", function(d) { return d.point; })
				.attr("class", "link")
				.attr("d", function(d) {
					//console.log(d);
					return "M" + d.y + "," + d.x
							+ "C" + (d.y + d.parent.y) / 2 + "," + d.x
							+ " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
							+ " " + d.parent.y + "," + d.parent.x;
				})

		var node = g.selectAll(".node")
				.data(root.descendants())
			.enter().append("g")
				.attr("class", function(d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
				.attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })

		node.append("circle")
				.attr("r", 2.5)
			  .style("stroke", function(d) { return d.point; })
				.style("fill", function(d) { return d.point; });

		node.append("text")
				.attr("dy", 3)
				.attr("x", function(d) { return d.children ? -8 : 8; })
				.style("text-anchor", function(d) { return d.children ? "end" : "start"; })
//				.style("fill", function(d) { return d.color; })
				.text(function(d) { return d.id.substring(d.id.lastIndexOf(".") + 1); });
				
//		var link = g.selectAll("path.link")
//			.style("stroke", function(d) { return d.point; })
//			.style("fill", function(d) { return d.point; });
////				.data(root, function (d) {
////						return d.target.id;
////				});
		link.enter()
			.style("stroke", function(d) { return d.point; })
			.style("fill", function(d) { return d.point; });
		
	});

	')
writeLines(myJS, 'myFunc.js')
#write.table(test, sep = ',', row.names = FALSE, col.names = testNames)

ui <- fluidPage(tags$head(tags$script(src = 'https://code.jquery.com/jquery-1.12.4.js'),
                  tags$script(src = 'https://d3js.org/d3.v4.min.js'),
                  tags$script(src = 'https://d3js.org/d3-color.v1.min.js'),
                  tags$script(src = 'https://d3js.org/d3-hierarchy.v1.min.js'),
                  includeCSS('style.css')),
    mainPanel(
      HTML('<svg width="660" height="500" style="padding-left:10%">'),
      #uiOutput("chart"))
      includeScript('myFunc.js'))
      #tags$script(src = 'myFunc.js'))
    )


server <- function(input, output) {
  output$chart <- renderUI({
    includeScript('myFunc.js')
  }) 
}


#Not quite ready yet?
shinyApp(ui = ui, server = server)

```